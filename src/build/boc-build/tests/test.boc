include ../../../../rules/test.boc;

var $(BOC_BUILD)=$(BUILD_BIN)/boc-build;
var $(BOC_BUILD_OPTS);

function setup_test_project()
{
    cp -r project $(TESTSUITE_DIR)/project;
    pushd $(TESTSUITE_DIR)/project;
}

function teardown_test_project()
{
    popd;

    echo "==== stderr ====" >> $(RAW_OUTPUT);
    cat $(TESTSUITE_DIR)/stderr >> $(RAW_OUTPUT);

    echo "==== stdout ====" >> $(RAW_OUTPUT);
    cat $(TESTSUITE_DIR)/stdout >> $(RAW_OUTPUT);

    call process_raw_output();
    call compare_output();
}

function list_test_project()
{
    $(BOC_BUILD)
        --list-targets
        $(BOC_BUILD_OPTS)
        >>$(TESTSUITE_DIR)/stdout
        2>>$(TESTSUITE_DIR)/stderr
        || true;
}

function build_test_project()
{
    $(BOC_BUILD)
        $(BOC_BUILD_OPTS)
        >>$(TESTSUITE_DIR)/stdout
        2>>$(TESTSUITE_DIR)/stderr
        || true;
}

function test_project_status()
{
    $(BOC_BUILD)
        --status
        $(BOC_BUILD_OPTS)
        >>$(TESTSUITE_DIR)/stdout
        2>>$(TESTSUITE_DIR)/stderr
        || true;
}

function inner_begin_project_phase(phase)
{
    echo $(phase) >>$(TESTSUITE_DIR)/stdout;
    echo $(phase) >>$(TESTSUITE_DIR)/stderr;
    echo $(phase) >>$(RAW_OUTPUT);
}

function begin_project_phase(phase)
{
    call inner_begin_project_phase("---- "$(phase)" ----");
}
